<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/file-upload/file-upload.html">

<link rel="import" href="../toothfairy-icons.html">

<dom-module id="plutonium-babylon-screen">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host {
                display: inline-block;
                overflow: hidden;
                width   : 100%;
                height  : 100%;
                margin  : 0;
                padding : 0;
            }
            
            .drawer-list {
                margin: 0 20px;
            }

            .drawer-list a {
                display: block;
                /*padding: 0 16px;*/
                text-decoration: none;
                color: var(--app-secondary-color);
                line-height: 40px;
            }

            .drawer-list a.iron-selected {
                /*color: black;*/
                font-weight: bold;
            }

            #renderCanvas {
                width   : 100%;
                height  : 100%;
                touch-action: none;
            }
        </style>
        <iron-ajax url="http://localhost:3000/list" last-response="{{files}}" auto on-response="_onModelListResponse"></iron-ajax>
        <app-drawer-layout id="appLayout" fullbleed>
            <app-drawer>
                <app-toolbar>
                    Menu
                </app-toolbar>
                <iron-list id="menuList" 
                           selected="[[page]]" 
                           attr-for-selected="name" 
                           class="drawer-list" 
                           role="navigation" 
                           items="[[mainMenus]]" 
                           as="menu" 
                           selection-enabled>
                    <template is="dom-repeat" items="[[files]]">
                        <a name="[[item]]" href="/[[item]]" class="paper-font-menu layout horizontal">[[item]]</a>
                    </template>
                </iron-list>

            </app-drawer>
            <app-header-layout class="layout horizontal">
                <app-header fixed condenses effects="waterfall">
                    <app-toolbar class="layout horizontal">
                        <paper-icon-button icon="toothfairy-icons:menu" drawer-toggle></paper-icon-button>
                        <div main-title>Toothfairy</div>
                        <div class="flex"></div>
                        <div id="uploadPanel" class="layout horizontal" hidden>
                            <file-upload id="uploader" droppable raised multi="false" accept="application/sla" target="http://localhost:3000/upload">Choose bodymodel</file-upload>
                            <paper-icon-button icon="toothfairy-icons:arrow-back" on-tap="_backToMain"></paper-icon-button>
                        </div>
                        <div id="actionsPanel" class="layout horizontal">
                            <paper-icon-button icon="toothfairy-icons:file-upload" on-tap="_showUpload"></paper-icon-button>
                            <paper-toggle-button checked="{{debugBabylon}}">Debug</paper-toggle-button>
                        </div>
                    </app-toolbar>
                </app-header>
                <div class="layout horizontal flex">
                    <div class="layout vertical flex">
                        <canvas id="renderCanvas" hidden="[[_canvasVisibilityIndicator]]"></canvas>
                    </div>
                </div>
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <!--<script src="../../bower_components/babylonjs/dist/babylon.2.5.js"></script>-->
    <script src="../../babylon.custom.js"></script>

    <script>
Polymer({
    is: 'plutonium-babylon-screen',
    behaviors: [
        Polymer.IronResizableBehavior
    ],
    properties: {
        engine: {
            type: Object
        },
        scene: {
            type: Object
        },
        assetsManager: {
            type: Object
        },
        camera: {
            type: Object
        },
        path: {
            type: String,
            notify: true,
//            value: 'sample.stl'
        },
        runningBabylon: {
            type: Boolean,
            notify: true,
            value: false
        },
        debugBabylon: {
            type: Boolean,
            notify: true,
            value: false
        },
        _canvasVisibilityIndicator: {
            type: Boolean,
            computed: '_computeCanvasVisibilityIndicator(path, runningBabylon)'
        }
    },
    observers: [
        '_observePath(assetsManager, path)',
        '_observeDebuggerIndicator(debugBabylon)'
    ],
    listeners: {
        'iron-resize': '_onResize',
        'uploader.success': '_onUploadSuccess',
        'babylon-initialize': '_onBabylonInitialize',
        'babylon-load': '_onBabylonLoad',
        'babylon-start': '_onBabylonStart',
        'babylon-stop': '_onBabylonStop'
    },
    attached: function () {
        this.fire('babylon-initialize', {});

        this.async(this.notifyResize, 1);
    },

    _observePath: function (assetsManager, path) {

        this.fire('babylon-load', {
            path: path
        });
    },
    _observeDebuggerIndicator: function (debugBabylon) {
        if (this.scene && this.camera) {
            console.debug(this.is, debugBabylon ? 'open debugging layer' : 'close debugging layer');
            if (debugBabylon) {
                this.scene.debugLayer.show(true, this.camera);
            } else {
                this.scene.debugLayer.hide();
            }
        }
    },
    _computeCanvasVisibilityIndicator: function (path, runningBabylon) {
        return !(path && runningBabylon);
    },
    _onBabylonInitialize: function (event, details) {
        console.debug(this.is, 'initialize babylon', details);
        this.engine = new BABYLON.Engine(this.$.renderCanvas, true);

        this.scene = new BABYLON.Scene(this.engine);

        this.camera = new BABYLON.ArcRotateCamera("Camera", 0, 0.8, 20, BABYLON.Vector3.Zero(), this.scene);
        this.camera.attachControl(this.$.renderCanvas, false);

        var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(20, 20, 100), this.scene);
        // Move the light with the camera
        this.scene.registerBeforeRender(function () {
            light.position = self.camera.position;
        });

        this.assetsManager = new BABYLON.AssetsManager(this.scene);
        var self = this;


        this.assetsManager.onFinish = function (tasks) {
            console.debug('Assets loaded.');
            self.fire('babylon-start', {});
        };
    },
    _onBabylonLoad: function (event, details) {
        console.debug(this.is, 'load babylon', details);
        var meshTask = this.assetsManager.addMeshTask("asset task", "", "temp/", details.path);
        var self = this;
        meshTask.onError = function (tasks) {
            console.warn('Assets not find.', tasks);
            self.fire('babylon-stop', {});
        };
        meshTask.onSuccess = function (task) {
            console.debug('Asset:', task);
                task.loadedMeshes[0].position = BABYLON.Vector3.Zero();
        };
        this.assetsManager.load();
    },
    _onBabylonStart: function (event, details) {
        console.debug(this.is, 'start babylon', details);
        var self = this;
        this.scene.activeCamera.attachControl(this.$.renderCanvas, false);
        this.engine.runRenderLoop(function () {
            self.scene.render();
        });
    },
    _onBabylonStop: function (event, details) {
        console.debug(this.is, 'stop babylon', details);
        this.engine.stopRenderLoop();
    },
    _showUpload: function () {
        this.$.uploadPanel.hidden = false;
        this.$.actionsPanel.hidden = true;
    },
    _backToMain: function () {
        this.$.uploadPanel.hidden = true;
        this.$.actionsPanel.hidden = false;
    },
    _onResize: function () {
        if (this.engine)
            this.engine.resize();
    },
    _onUploadSuccess: function (event, details) {
        console.debug(this.is, 'uploaded', details);
        this.fire('babylon-stop', {});
        this.runningBabylon = true;
        this.assetsManager.reset();
        this.fire('babylon-load', {
            path: JSON.parse(details.xhr.response).name
        });
    },

    _onModelListResponse: function (event, data) {
        console.debug(this.is, 'Fetched model list.');
        this.$.appLayout.notifyResize();
    }
    /**
     * Clicks the invisible file input
     */
//    _fileChange: function () {
//        var elem = this.$.fileInput;
//
//        var tokens = this.$.fileInput.value.split('\\');
//        var fileName = tokens[tokens.length - 1];
//        console.log('Select file', fileName);
//        this.path = fileName;
////        if (elem && document.createEvent) { // sanity check
////            var evt = document.createEvent("MouseEvents");
////            evt.initEvent("click", true, false);
////            elem.dispatchEvent(evt);
////        }
//    },
});
    </script>
</dom-module>
