<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles-classes.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/file-upload/file-upload.html">

<link rel="import" href="../toothfairy-icons.html">

<dom-module id="plutonium-babylon">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host {
                display: inline-block;
                overflow: hidden;
                width   : 100%;
                height  : 100%;
                margin  : 0;
                padding : 0;
            }

            #renderCanvas {
                width   : 100%;
                height  : 100%;
                touch-action: none;
            }
        </style>
        <canvas id="renderCanvas" hidden="[[_canvasVisibilityIndicator]]"></canvas>
    </template>

    <!--<script src="../../bower_components/babylonjs/dist/babylon.2.5.js"></script>-->
    <script src="../babylon.custom.js"></script>

    <script>
        Polymer({
            is: 'plutonium-babylon',
            extends: 'div',
            behaviors: [
                Polymer.IronResizableBehavior
            ],
            properties: {
                engine: {
                    type: Object
                },
                scene: {
                    type: Object
                },
                assetsManager: {
                    type: Object
                },
                camera: {
                    type: Object
                },

                path: {
                    type: String,
                    notify: true,
//            value: 'sample.stl'
                },
                runningBabylon: {
                    type: Boolean,
                    notify: true,
                    value: false
                },
                debugBabylon: {
                    type: Boolean,
                    notify: true,
                    value: false
                },
                _canvasVisibilityIndicator: {
                    type: Boolean,
                    computed: '_computeCanvasVisibilityIndicator(path, runningBabylon)'
                }
            },
            observers: [
                '_observePath(assetsManager, path)',
                '_observeDebuggerIndicator(debugBabylon)'
            ],
            listeners: {
                'iron-resize': '_onResize',
//                'uploader.success': '_onUploadSuccess',
                'babylon-initialize': '_onBabylonInitialize',
                'babylon-load': '_onBabylonLoad',
                'babylon-start': '_onBabylonStart',
                'babylon-stop': '_onBabylonStop'
            },
            attached: function () {
                this.fire('babylon-initialize', {});
                this.runningBabylon = true;

                this.async(this.notifyResize, 1);
            },

            _observePath: function (assetsManager, path) {

                this.fire('babylon-load', {
                    path: path
                });
            },
            _observeDebuggerIndicator: function (debugBabylon) {
                if (this.scene && this.camera) {
                    console.debug(this.is, debugBabylon ? 'open debugging layer' : 'close debugging layer');
                    if (debugBabylon) {
                        this.scene.debugLayer.show(true, this.camera);
                    } else {
                        this.scene.debugLayer.hide();
                    }
                }
            },
            _computeCanvasVisibilityIndicator: function (path, runningBabylon) {
                return !(path && runningBabylon);
            },
            _onBabylonInitialize: function (event, details) {
                console.debug(this.is, 'initialize babylon', details);
                this.engine = new BABYLON.Engine(this.$.renderCanvas, true);

                this.scene = new BABYLON.Scene(this.engine);

                this.camera = new BABYLON.ArcRotateCamera("Camera", 0, 0.8, 20, BABYLON.Vector3.Zero(), this.scene);
                this.camera.attachControl(this.$.renderCanvas, false);

                var light = new BABYLON.PointLight("Omni", new BABYLON.Vector3(20, 20, 100), this.scene);
                // Move the light with the camera
                this.scene.registerBeforeRender(function () {
                    light.position = self.camera.position;
                });

                this.assetsManager = new BABYLON.AssetsManager(this.scene);
                var self = this;


                this.assetsManager.onFinish = function (tasks) {
                    console.debug('Assets loaded.');
                    self.fire('babylon-start', {});
                };
            },
            _onBabylonLoad: function (event, details) {
                console.debug(this.is, 'load babylon', details);

                var modelMesh = this.scene.getNodeByName('Mesh');
                while (modelMesh) {
                    console.debug(this.is, 'dispose earlier model.');
                    this.scene.removeMesh(modelMesh);
                    modelMesh.dispose();
                    modelMesh = this.scene.getNodeByName('Mesh');
                    
                }
                this.assetsManager.reset();
//                
                var meshTask = this.assetsManager.addMeshTask("asset task", ['model'], "../temp/", details.path);
                var self = this;
                meshTask.onError = function (tasks) {
                    console.warn('Assets not find.', tasks);
                    self.fire('babylon-stop', {});
                };
                meshTask.onSuccess = function (task) {
                    console.debug('Asset:', task);
                    task.loadedMeshes[0].position = BABYLON.Vector3.Zero();
                };
                this.assetsManager.load();
            },
            _onBabylonStart: function (event, details) {
                console.debug(this.is, 'start babylon', details);
                var self = this;
                this.scene.activeCamera.attachControl(this.$.renderCanvas, false);
                this.engine.runRenderLoop(function () {
                    self.scene.render();
                });
            },
            _onBabylonStop: function (event, details) {
                console.debug(this.is, 'stop babylon', details);
                this.engine.stopRenderLoop();
            },
//            _showUpload: function () {
//                this.$.uploadPanel.hidden = false;
//                this.$.actionsPanel.hidden = true;
//            },
//            _backToMain: function () {
//                this.$.uploadPanel.hidden = true;
//                this.$.actionsPanel.hidden = false;
//            },
            _onResize: function () {
                if (this.engine)
                    this.engine.resize();
            },
//            _onUploadSuccess: function (event, details) {
//                console.debug(this.is, 'uploaded', details);
//                this.fire('babylon-stop', {});
//                this.assetsManager.reset();
//                this.fire('babylon-load', {
//                    path: JSON.parse(details.xhr.response).name
//                });
//            },
//
//            _onModelListResponse: function (event, data) {
//                console.debug(this.is, 'Fetched model list.');
//                this.$.appLayout.notifyResize();
//            }
            /**
             * Clicks the invisible file input
             */
//    _fileChange: function () {
//        var elem = this.$.fileInput;
//
//        var tokens = this.$.fileInput.value.split('\\');
//        var fileName = tokens[tokens.length - 1];
//        console.log('Select file', fileName);
//        this.path = fileName;
////        if (elem && document.createEvent) { // sanity check
////            var evt = document.createEvent("MouseEvents");
////            evt.initEvent("click", true, false);
////            elem.dispatchEvent(evt);
////        }
//    },
        });
    </script>
</dom-module>
